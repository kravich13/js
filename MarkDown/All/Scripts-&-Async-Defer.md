## Скрипты: async & defer

В современных сайтах скрипты обычно тяжее, чем HTML: они весят больше и дольше обрабатываются.

Когда браузер загружает HTML и доходит до тега `<script>...</script>`, он не может продолжать строить DOM. Он должен сначала выполнить скрипт. То же самое происходит и с внешними скриптами `<script src="..."></script>`: браузер должен подождать, пока загрузится скрипт, выполнить его, и только затем обработать остальную страницу.

Из-за этого возникают две большие проблемы: 
1. Скрипты не видят DOM-элементы ниже себя, поэтому к ним нельзя добавить обработчики и т.д.
2. Если вверху страницы объёмный скрипт, он блокирует страницу. Пользователи не видят содержимое страницы, пока он не загрузится и не запустится.

```html
<!-- Этот тег виден сразу же -->
<p>Текст до скрипта</p>

    
<!-- Делается скрипт с задержкой для наглядности -->
<script src="https://javascript.info/article/script-async-defer/long.js?speed=1"></script>


<!-- Этот тег будет виден лишь после того, как загрузится скрипт выше и никак по другому -->
<p>Текст  после скрипта</p>
```

Эту проблему можно обойти загрузив скрипт в самом конце `body`, но это не решает глобальной проблемы.
***

## defer

`defer` скрипты загружаются параллельно, но ждут полной загрузки HTML и выполняются только после отрисовки. 

При этом сохраняется относительная очередность скриптов - кто раньше в коде, тот раньше будет исполнен (даже если загрузился последним), остальные будут ждать своей очереди
В принципе этот атрибут достаточен для размещения скриптов в `<head>`, например, благодаря ему они все равно будут ждать прогрузку `body` ниже.

```html
<!-- defer сообщает браузеру, что он должен обрабатывать страницу и загружать скрипт в фоновом режиме, а затем запустить этот скрипт, когда он загрузится -->

<p>Тег до скрипта</p>


<script defer src="https://javascript.info/article/script-async-defer/long.js?speed=1"></script>


<!-- Обрабатывается сразу же -->
<p>Тег после скрипта</p>
```

* Скрипты с `defer` никогда не блокируют страницу
* Скрипты с `defer` всегда выполняются, когда DOM готово, но до события `DOMContentLoaded`.

Пример: 

```HTML
<p>Тег до скрипта</p>


<!-- Загрузится лишь после всех defer -->
<script>
    document.addEventListener('DOMContentLoaded', () => alert("Дерево DOM готово после скрипта с 'defer'!")); // (2)
</script>


<script defer src="https://javascript.info/article/script-async-defer/long.js?speed=1"></script>


<!-- показывается сразу -->
<p>Тег после скрипта</p>
```

Отложенные с помощью `defer` скрипты сохраняют порядок относительно друг друга, как и обычные скрипты.

Если сначала загружается большой скрипт, а затем маленький - то маленький скрипт будет ждать, пока выполнится большой скрипт:

```HTML
<!-- Большой скрипт загрузится последним, но выполнится первым-->
<script defer src="https://javascript.info/article/script-async-defer/long.js"></script> 

<!-- Маленький загрузится первым, но выполнится вторым-->
<script defer src="https://javascript.info/article/script-async-defer/small.js"></script> 
```

**Атрибут `defer` предназначен только для внешних скриптов, если в теге нет `src="..."`, то артибут `defer` будет проигнорирован.**
***

## async

`async` скрипты загружаются параллельно со всем остальным и вызываются по готовности. Какой быстрее загрузился - тот раньше выполняется, очередность в коде не имеет значения.

Обычно применяется для совершенно независимых от контента на странице ресурсов - типа счетчиков и аналитики.

Так что, если есть несколько `async` скриптов, они могут выполняться в любом порядке. Кто первый загрузился - тот и выполняется: 

```html
 <!-- Скрипты выполняются в порядке загрузки -->

<!-- Большой скрипт расположен первее маленького, но маленький сработает раньше большого -->
<script async src="https://javascript.info/article/script-async-defer/long.js"></script>
<script async src="https://javascript.info/article/script-async-defer/small.js"></script>

<!-- Содержимое показывается сразу же, async его не блокирует -->
<p>Текст после скриптов</p>
```
***

## Динамически загружаемые скрипты

Можно добавить динамически загружаемый скрипт с помощью JS:

```javascript
const script = document.createElement('script');
script.src = "/article/script-async-defer/long.js";
document.body.append(script); // (*)
```

Скрипт начнёт загружаться сразу, как будет добавлен в документ.

**Динамически созданные скрипты по умолчанию ведут себя как `async`:**
* Никого не ждут и их никто не ждёт
* Скрипт, который загрузился первый и будет выполняться первым.

 Также можно изменить относительный порядок скриптов с "первый загрузился - первый выполнился" на порядок, в котором они расположены в документе (как в обычных скриптах) с помощью явной установки `async` в `false`:

 ```html
<script>
    function loadScript(src) {
        const script = document.createElement('script');
        script.src = src;
        script.async = false // async выключить
        document.body.append(script);
    }
    
    // Большой скрипт запустится первый, потому что async = false
    loadScript("/article/script-async-defer/long.js");

    // Маленький запустится после большого
    loadScript("/article/script-async-defer/small.js");
</script>
```
***



