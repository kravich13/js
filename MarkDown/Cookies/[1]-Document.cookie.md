## Document.cookie

Куки - это небольшие строки данных, которые хранятся в оперативной памяти браузера. 

Один из наиболее частых случаев применения куни - является аутентификация:

1. При входе на сайт сервер отсылает в ответ HTTP-заголовок `Set-Cookies` для того, чтобы установить куки со специальным уникальным идентификатором сессии.
2. Во время следующего запроса к этому же домену браузер посылает на сервер HTTP-заголовок `Cookie`
3. Таким образом, сервер понимает, кто делал запрос.

Также можно получить доступ к куки из браузера, используя свойство `document.cookie`.
***

## Чтение из document.cookie

Чтобы посмотреть куки с сайта, нужно их посмотреть:

```javascript
console.log(document.cookie) // cookie1=value1; cookie2=value2; ...
```

Значение `document.cookie` состоит из пар `key=value`, прямо как в объекте, но в виде строки и разделён знаком `;`. Каждая пара представляет собой отдельное куки.

Чтобы найди определенное куки, достаточно разбить строку по знаку `;` и затем найти нужный ключ. Для этого можно использовать методы массивов.
***

## Запись в document.cookie

`document.cookie` не просто строка, а акрессор. Присваивание обрабатываеся особым образом: 

**Запись в `document.cookie` только обновит его куки, но при этом не затронет старые куки.**

К примеру, этот вызов установит куки с именем `user` и значением `Vlad`:

```javascript
document.cookie = "user=Vlad"
console.log(document.cookie) // user=Vlad

// перезапись того же key user:
document.cookie = "user=Kravich"
console.log(document.cookie) // user=Kravich
```

Технически, и имя и значение куки могут состоять из любых символов, для правильного форматирования следует использовать встроенную функцию `encodeURIComponent`:

```javascript
const name = "my name"
const value = "Vlad Kravich"

document.cookie = `${encodeURIComponent(name)} = ${encodeURIComponent(value)}` 

console.log(document.cookie) // my%20name=Vlad%20Kravich
```

**У куки есть ряд настроек, многие из которых важны и должны быть установлены.**

Эти настройки указываются после пары `key=value` и отделены друг от друга разделителем `;`, вот так:

```javascript
document.cookie = "user=Vlad; path=/; expires=Tue; 17 Aug 2033 03:13:13 GMT"
```
***

## path

* **path=/mypath**

URL-префикс пути, куки будут доступны для страниц под этим путём. Должен быть абсолютным. По умолчанию используется текущий путь.

`path=/` означает, что весь контент куки будет доступен на странице `kravich.com`.

Если куки установлено с `path=/admin` - то оно будет доступно на страницах `/admin` и `/admin/something`, но не на страницах `/home` или `/adminpage`.

Обычно указывают в качестве пути корень `path=/`, чтобы куки был доступен на всех страницах.
***

## domain

* **domain=kravich.com**

Домен, на котором доступны наши куки. На практике есть ограничения - нельзя указать здесь какой угодно домен.

По умолчанию куки доступно лишь тому домену, который его установил. Так что куки, которые были установлены сайтом `kravich.com`, не будут на сайте `tesla.com`.

На поддомене `forum.kravich.com` получить куки нельзя.

```javascript
// С kravich.com
document.cookie = "user=Vlad"

// На forum.kravich.com
console.log(document.cookie) // нет user
```

**Нет способа сделать куки доступным на другом домене 2-о уровня, так что `tesla.com` никогда не получит куки, установленные сайтом `kravich.com`.**

Сделано это для безопасности, чтобы в куки можно было хранить кондефициальные данные, предназначенные только для одного сайта.

Если всё таки нужно дать поддаменам типа `forum.kravich.com` доступ к куки, это можно сделать.
Достаточно при установке куки на сайте `kravich.com` в качестве опции `domain` указать корневой домен: `domain=kravich.com`:

```javascript
// На kravich.com
document.cookie = "user=Vlad; domain=kravich.com"

// Доступны на forum.kravich.com
console.log(document.cookie) // есть куки user=Vlad
```

Для поддержки старых браузеров нужно писать `domain=.kravich.com`, тогда в них тоже будет работать.
***

## expires, max-age

По умолчанию, если куки не имеют этих двух параметров, они удаляются при закрытии браузера автоматически. Такие куки называются "сессионными".

Чтобы помочь куки пережить закрытие браузера, нужно установить значение опций `expires` или `max-age`:
* **expires=Tue, 17 Aug 2033 03:13:13 GMT**

При истеченинии даты куки удалится автоматически.

Дата должна быть точно в этом формате, во временной зоне GMT. Можно использовать `date.toUTCString`, чтобы получить правильную дату. 

Пример установки куки на один день: 

```javascript
let date = new Date(Date.now() + 86400000)
date = date.toUTCString()
document.cookie = `user=Vlad, expires=${date}`

// Через 1 день куки удалится
console.log(document.cookie) // user=Vlad, expires=Tue, 18 Aug 2020 13:16:37 GMT"
```

Если установить в `expires` прошедшую дату, то куки будет удалено.

`max-age: 3600` - альтернатива `expires`, определяет срок действия куки в секундах с текущего момента.

Если задан ноль или отрицательное значение, куки будет удалено: 

```javascript
// Куки удалится через час
document.cookie = "user=Vlad; max-age: 3600"

// Удалим куки сразу
document.cookie = "user=Vlad; max-age: 0"
```
***

## secure 

Куки следует передавать только по HTTPS протоколу.

**По умолчанию куки, установленные сайтом http://kravich.com, также будут доступны на сайте https://kravich.com и наоборот.**

Т.е. куки опираются на доменное имя и они не обращают внимания на протоколы.

Если установить флаг `secure`на протоколе https://kravich.com, то оно не будет доступно на том же сайте с протоколом HTTP, как http://kravich.com. 

Таким образом, если в куки хранится конфедициальная информация, которую не следует передавать по незашифрованному протоколоу HTTP, то нужно установить флаг `secure`:

```javascript
// сейчас мы на https://

// установка secure запретит использовать куки на HTTP
document.cookie = "user=Vlad; secure"
```
***

## Настройка samesite

* **somesite=strict (или тоже самое, что somesite без значения).**

Куки с `samesite=strict` никогда не отправится, если пользователь пришел не с этого же сайта.

Куки с настройкой `samesite` будет отправлено только в том случае, если операции происходят с сайта `bank.com`, например отправка формы сделана со страницы на `bank.com`.

Когда пользователь перейдёт по ссылке на `bank.com`, например из своих заметок, он будет удивлён, что сайт `bank.com` не узнал его. Действительно, куки с `samesite=strict` в этом случае не отправляется.

Мы могли бы обойти это ограничение, используя два куки: одно куки для «общего узнавания», только для того, чтобы поздороваться: «Привет, Джон», и другое куки для операций изменения данных с `samesite=strict`. Тогда пользователь, пришедший на сайт, увидит приветствие, но платежи нужно инициировать с сайта банка, чтобы отправилось второе куки.

* **samesite=lax**

Режим `lax`, как и `strict`, запрещает браузеру отправлять куки, когда запрос происходит не с сайта, но добавляет одно исключение.

Куки с `somesite=lax` отправляется, если два условия верны: 
1. Используется метод `GET`, но не `POST`.
2. Операция осуществляет навигацию верхнего уровня (изменяет URL в адресной строке браузера).

Таким образом, режим `somesite=lax` позволяет операции "переход по ссылке" передавать куки.

**somesite игнорируется браузерами, выпущенными до 2017 года и ранее.**

