- [Теневой DOM и события](#теневой-dom-и-события)
- [Всплытие и метод event.composedPath()](#всплытие-и-метод-eventcomposedpath)
- [Свойство event.composed](#свойство-eventcomposed)
- [Генерация событий](#генерация-событий)

## Теневой DOM и события

Смысл создания теневого DOM-дерева – это инкапсуляция внутренних деталей компонента.

Допустим, клик произошёл внутри теневого DOM на компоненте `<select-search>`, светлый дом ничего не знает про внутреннее устройство `shadow dom`, по этому клик в светлом доме будет срабатывать на самом элемент `<select-search>`, а не на его `<input>, <div>` и прочее.

Точно также нельзя из теневого дома отслеживать события из светлого дома.
***

## Всплытие и метод event.composedPath()

Для обеспечения всплытия событий используется развёрнутый DOM.

Таким образом, если есть элемент в слоте, и событие происходит где-то внутри него, то оно всплывает до `<slot>` и выше.

Полный путь к изначальному целевому элементу, со всеми теневыми элементами, можно получить, воспользовавшись методом `event.composedPath()`. 

В примере выше развёрнутое DOM-дерево будет таким:

```html
<user-card id="userCard">
  #shadow-root
    <div>
      <b>Имя:</b>
      <slot name="username">
        <span slot="username">John Smith</span>
      </slot>
    </div>
</user-card>
```

Так что, при клике по `<span slot="username">` вызов метода `event.composedPath()` вернёт массив: `[span, slot, div, shadow-root, user-card, body, html, document, window]`. Что в точности отражает цепочку родителей от целевого элемента в развёрнутой DOM-структуре после композиции.

**Детали теневого DOM-дерева доступны только для деревьев с `{mode: "open"}`.**
***

## Свойство event.composed

Большинство событий успешно всплывают сквозь границу теневого DOM. Но не все.

Это поведение регулируется с помощью свойства composed объекта события. Если оно true, то событие пересекает границу. Иначе, оно может быть поймано лишь внутри теневого DOM.

Если посмотреть в спецификацию UI Events, то большинство событий имеют composed: `true`:

* `blur, focus, focusin, focusout`,
* `click, dblclick,`
* `mousedown, mouseup mousemove, mouseout, mouseover,`
* `wheel,`
* `beforeinput, input, keydown, keyup.`

Все события курсора и сенсорные события также имеют composed: `true`.

Хотя есть и события, имеющие `composed: false`:

* `mouseenter, mouseleave (они вообще не всплывают)`,
* `load, unload, abort, error`,
* `select`,
* `slotchange`.

Эти события могут быть пойманы только на элементах того же DOM, в котором находится целевой элемент события.
***

## Генерация событий

Когда мы генерируем своё событие, то, чтобы оно всплывало за пределы компонента, нужно в `dispatchEvent` установить оба свойства: `bubbles` и `composed` – в значение `true`.

